name: Fuzz

on:
  schedule:
    - cron: '0 2 * * 0'  # Weekly: Sunday at 2 AM UTC
  workflow_dispatch:
    inputs:
      fuzz_time:
        description: 'Duration per target (e.g., 300 for 5 minutes)'
        default: '600'
        type: string
      target:
        description: 'Specific target (or "all")'
        default: 'all'
        type: choice
        options:
          - all
          - fcps_frame
          - fcpc_frame
          - fcps_datagram
          - capability
          - session
          - session_transcript
          - zone_key_manifest

permissions:
  contents: read

concurrency:
  group: fuzz
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Matrix Fuzzing: Run all fuzz targets in parallel
  # ─────────────────────────────────────────────────────────────────────────────
  fuzz:
    name: Fuzz ${{ matrix.target }}
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        target:
          - fcps_frame
          - fcpc_frame
          - fcps_datagram
          - capability
          - session
          - session_transcript
          - zone_key_manifest
    steps:
      - uses: actions/checkout@v4

      - name: Skip if specific target requested
        if: inputs.target != 'all' && inputs.target != matrix.target
        run: echo "Skipping ${{ matrix.target }} (requested: ${{ inputs.target }})" && exit 0

      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
        with:
          key: fuzz-${{ matrix.target }}

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz --locked

      - name: Download corpus (if cached)
        uses: actions/cache@v4
        with:
          path: fuzz/corpus/${{ matrix.target }}
          key: fuzz-corpus-${{ matrix.target }}-${{ github.run_number }}
          restore-keys: |
            fuzz-corpus-${{ matrix.target }}-

      - name: Run fuzzer
        run: |
          FUZZ_TIME="${{ inputs.fuzz_time || '600' }}"
          echo "Fuzzing ${{ matrix.target }} for ${FUZZ_TIME} seconds..."
          cargo fuzz run ${{ matrix.target }} -- \
            -max_total_time=${FUZZ_TIME} \
            -print_final_stats=1 \
            2>&1 | tee fuzz-${{ matrix.target }}.log
        continue-on-error: true

      - name: Check for crashes
        id: check
        run: |
          ARTIFACTS_DIR="fuzz/artifacts/${{ matrix.target }}"
          if [[ -d "$ARTIFACTS_DIR" ]] && [[ -n "$(ls -A $ARTIFACTS_DIR 2>/dev/null)" ]]; then
            echo "::error::Fuzzer found crashes in ${{ matrix.target }}!"
            echo "crashes=true" >> $GITHUB_OUTPUT
            ls -la "$ARTIFACTS_DIR"
          else
            echo "No crashes found"
            echo "crashes=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload crash artifacts
        if: steps.check.outputs.crashes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: crashes-${{ matrix.target }}
          path: fuzz/artifacts/${{ matrix.target }}/
          retention-days: 30

      - name: Upload fuzz log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-log-${{ matrix.target }}
          path: fuzz-${{ matrix.target }}.log
          retention-days: 7

      - name: Save corpus
        uses: actions/cache/save@v4
        if: always()
        with:
          path: fuzz/corpus/${{ matrix.target }}
          key: fuzz-corpus-${{ matrix.target }}-${{ github.run_number }}

  # ─────────────────────────────────────────────────────────────────────────────
  # Summary: Report fuzzing results
  # ─────────────────────────────────────────────────────────────────────────────
  summary:
    name: Fuzz Summary
    needs: fuzz
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all logs
        uses: actions/download-artifact@v4
        with:
          pattern: fuzz-log-*
          path: logs
          merge-multiple: true

      - name: Generate summary
        run: |
          echo "## Fuzz Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Status | Executions | Crashes |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|------------|---------|" >> $GITHUB_STEP_SUMMARY

          for log in logs/*.log; do
            if [[ -f "$log" ]]; then
              target=$(basename "$log" .log | sed 's/fuzz-//')
              execs=$(grep -oP 'stat::number_of_executed_units:\s*\K\d+' "$log" | tail -1 || echo "N/A")
              if grep -q "BINGO\|SUMMARY: libFuzzer" "$log"; then
                status="CRASH"
                crashes="Yes"
              else
                status="OK"
                crashes="None"
              fi
              echo "| $target | $status | $execs | $crashes |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Check for any crashes
        run: |
          if ls logs/*.log 2>/dev/null | xargs grep -l "BINGO\|AddressSanitizer\|SUMMARY: libFuzzer: deadly signal" 2>/dev/null; then
            echo "::error::One or more fuzz targets found crashes!"
            exit 1
          fi
          echo "All fuzz tests completed without crashes"
